---
title: "Docker + Nginx + Laravelã®é–‹ç™ºç’°å¢ƒæ§‹ç¯‰ã‹ã‚‰Herokuã¸ã®Deployã¾ã§"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['docker', 'nginx', 'laravel', 'heroku'] 
published: true
---

## æ¦‚è¦
æ™‚ä»£ã¯SPAã§ã™ãŒã€ã¾ã ã¾ã ãƒ¢ãƒãƒªã‚·ãƒƒã‚¯ãªç’°å¢ƒã‚’ä½œã‚‹å ´é¢ãŒã‚ã‚‹ã®ã§ãƒ¡ãƒ¢ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚
Laravelã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯èª¿æ•´ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚
â€»1 è¨˜äº‹ã§ã¯LTSã§ã‚ã‚‹6ç³»ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
â€»2 DBã¯Herokuã¸Deployã™ã‚‹äº‹ã‚’å‰æã¨ã—ã¦ã„ã‚‹ã®ã§PostgreSQLã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

## DockerImageã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç­‰
- php:7.4-fpm-alpine
- nginx:1.19-alpine
- postgres:12

## å®Œæˆå›³ã¨æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰
### å®Œæˆå›³
![](https://storage.googleapis.com/zenn-user-upload/9hlmb25kl5fo477q9yynz8931arr)

### æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰
https://github.com/nagi125/laravel-docker-template
Herokuã«ç›´æ¥Deployã§ãã‚‹ã‚ˆã†ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’èª¿æ•´ã—ã¦ã‚ã‚Šã¾ã™ã€‚ 

### ã–ã£ãã‚Šè§£èª¬
.dockerãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«Dockerfileã¨confãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã—ã¦ã€docker-compose.ymlã«ã¦ãã‚Œãã‚Œã®ã‚³ãƒ³ãƒ†ãƒŠã®é–¢ä¿‚ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
Nginxã®ã€Œ/app/publicã€ã¨Laravelã®ã€Œ/app/publicã€ãŒå…±æœ‰ã—ã¦ã„ã‚‹ã¨ã“ã‚ãŒãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šã¾ã™ã€‚
ã“ã“ã®å…±æœ‰ãŒã§ãã¦ã„ãªã„ã¨ã€é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”ã™äº‹ãŒã§ãã¾ã›ã‚“ã€‚

docker-compose.yml
```yml
version: '3'
services:
  nginx:
    container_name: nginx
    build: .docker/nginx
    ports:
      - 80:80
    volumes:
      - .:/app
    tty: true
    restart: always
    depends_on:
      - app

  app:
    container_name: app
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      LANG: 'ja_JP.UTF-8'
      TZ: 'Asia/Tokyo'
      LOG_CHANNEL: 'stderr'
      DB_CONNECTION: 'pgsql'
      DB_HOST: 'db'
      DB_PORT: '5432'
      DB_DATABASE: 'laravel_development'
      DB_USERNAME: 'docker'
      DB_PASSWORD: 'docker'
    volumes:
      - .:/app
    expose:
      - 9000
    tty: true
    restart: always
    depends_on:
      - db

  db:
    image: postgres:12
    container_name: db
    environment:
      TZ: 'Asia/Tokyo'
      POSTGRES_USER: 'docker'
      POSTGRES_PASSWORD: 'docker'
      POSTGRES_DB: 'laravel_development'
    volumes:
      - db:/var/lib/postgresql/data
    ports:
      - 5432:5432

volumes:
  db:
```

## Laravelã®æº–å‚™
https://github.com/nagi125/laravel-docker-template
ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦Laravelã®æº–å‚™ã‚’ã—ã¾ã™ã€‚

### ç’°å¢ƒç«‹ã¡ä¸Šã’
```
$ docker-compose up
```

### Laravelã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ç›´ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½œã‚ã†ã¨ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¦ã„ã¦æ€’ã‚‰ã‚Œã‚‹ãŸã‚ã€ä¸€åº¦ã€Œblogã€ã¨ã—ã¦ä½œæˆã—ã¾ã™ã€‚
```
$ docker-compose exec app composer create-project --prefer-dist laravel/laravel blog "6.*"
```

blogå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´ä¸‹ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
â€»Macå´ã§ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚’ã™ã‚‹ã¨æ—©ãçµ‚ã‚ã‚Šã¾ã™ã€‚
```
$ docker-compose exec app cp -R ./blog/. ./
```

æœ€å¾Œã«blogã‚’å‰Šé™¤ã—ã¾ã™ã€‚
```
$ docker-compose exec app rm -rf blog
```

ã€Œhttp://localhostã€ã§Welcomeç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚

## Herokuã«Deploy
### Herokuå´ã®Nginxã®æº–å‚™
Herokuå´ã§nginxã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€.heroku/nginx/ã«nginx.confã‚’æº–å‚™ã—ã¾ã™ã€‚
â€».herokuã¯ç§ãŒå‹æ‰‹ã«ã¤ã‘ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåãªã®ã§ã€ä»–ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã§ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

.heroku/nginx/nginx.conf
```
location / {
    # try to serve file directory, fallback to rewrite
    try_files $uri @rewriteapp;
}

location @rewriteapp {
    # rewrite all to index.php
    rewrite ^(.*)$ /index.php/$1 last;
}
```

### Procfileã®æº–å‚™
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã«Procfileã‚’æº–å‚™ã—ã¾ã™ã€‚
Herokuã®è¨­å®šã‚„ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã“ã“ã§è¨˜è¿°ã—ã¾ã™ã€‚

Procfile
```
web: vendor/bin/heroku-php-nginx -C .heroku/nginx/nginx.conf public/
```

### heroku-cliã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
$ brew tap heroku/brew && brew install heroku
```

### Herokuã«ãƒ­ã‚°ã‚¤ãƒ³
```
$ heroku login
```
ãƒ–ãƒ©ã‚¦ã‚¶ãŒç«‹ã¡ä¸ŠãŒã‚‹ã®ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨Terminalå´ã‚‚ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã¨ãªã‚Šã¾ã™ã€‚

### Herokuã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹
```
$ heroku apps:create your-app-name
```

### Herokuã®Buildè¨­å®šã‚’ã™ã‚‹
Buildã™ã‚‹éš›ã«PHPã¨Node.jsã‚’ä½¿ç”¨ã™ã‚‹ã®ã§è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚
```
$ heroku buildpacks:add heroku/php -a your-app-name
$ heroku buildpacks:add heroku/nodejs -a your-app-name
```

### Herokuã«Deployã™ã‚‹
â€» 2020å¹´10æœˆæ™‚ç‚¹ã§ã¯masterã€mainã©ã¡ã‚‰ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
```
$ git push heroku main
```

### Herokuå´ã«ç’°å¢ƒå¤‰æ•°ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
Herokuå´ã®ç’°å¢ƒå¤‰æ•°ã«APP_KEYã‚’setã™ã‚‹
```
$ heroku config:set APP_KEY=your-app-key -a your-app-name
```

### ç¢ºèª
```
$ heroku open
```

## æœ€å¾Œã«
ä»¥ä¸Šã§é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®ä¸‹æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
æœ¬ç•ªé‹ç”¨ã™ã‚‹å ´åˆã¯DBè¨­å®šãƒ»S3è¨­å®šãƒ»Sessionè¨­å®šãƒ»Mailè¨­å®šãƒ»ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šç­‰
è¨­å®šã™ã‚‹äº‹ãŒã¾ã ãŸãã•ã‚“ã‚ã‚Šã¾ã™ãŒã€ã“ã®è¨˜äº‹ã§ã¯Herokuã¸ã®Deployã¾ã§ã¨ã—ã¾ã™ã€‚
å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚