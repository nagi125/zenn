---
title: "Hubotã¨Slackã‚’é€£æºã—ã¦æ–‡å­—ã‚„ç”»åƒã‚’è¿”ã™(2020å¹´ç‰ˆ)"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['hubot', 'slack', 'docker', 'heroku']
published: true
---

## æ¦‚è¦
ä»Šã•ã‚‰ã§ã™ãŒHubotã¨Slackã‚’é€£æºã—ã¦éŠã‚“ã§ã¿ãŸã‚‰çµæ§‹æ¥½ã—ã‹ã£ãŸã®ã§è¨˜äº‹ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚

## å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸
![](https://storage.googleapis.com/zenn-user-upload/vbe7wcntgk284fa7wuuhb1cq6cbj)
â€» ç¾å ´çŒ«ã®ç”»åƒã‚’ãŠå€Ÿã‚Šã—ã¦ã„ã¾ã™ğŸ™‡â€â™‚ï¸

## å®Œæˆå“
https://github.com/nagi125/hubot-slack-sample


## Slackå´ã®è¨­å®š
äº‹å‰ã«Slackå´ã«Hubotã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚
Appæ¤œç´¢ã§Hubotã¨èª¿ã¹ã‚Œã°ã§ã¦ãã¾ã™ã®ã§ã€ŒSlackã«è¿½åŠ ã€ã‚’æŠ¼ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/vi7ruqcc6oqrxexc3gs778ve2xx3)

ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§å…¥åŠ›ã—ã¾ã™ã€‚
Botã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ãªã‚Šã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/6dh33hhk9exhshiz0yunxqud2j6e)

TokenãŒç™ºè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã‚Œã‚’ã‚µãƒ¼ãƒãƒ¼å´ã«è¨­å®šã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/ypc3hpy0xl1d2zrrnzn4rcph99q3)

Slackå´ã«BotãŒä½œæˆã•ã‚Œã¦ã„ã‚Œã°ã€Slackå´ã®è¨­å®šã¯å®Œäº†ã§ã™ã€‚
â€»ç¾å ´çŒ«ã®ç”»åƒã‚’ãŠå€Ÿã‚Šã—ã¦ã„ã¾ã™ğŸ™‡â€â™‚ï¸
![](https://storage.googleapis.com/zenn-user-upload/ivn4j1gu48dwfa1mn4i2tb60tfl2)

## Dockerã‚’åˆ©ç”¨ã—ã¦Localç’°å¢ƒã§å‹•ã‹ã™
### Dockerç’°å¢ƒæº–å‚™
Dockerfileã¨docker-compose.ymlã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚
Hubotä½œæˆæ™‚ã«rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã ã¨æ€’ã‚‰ã‚Œã¦ã—ã¾ã†ã®ã§ã€hubotãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æº–å‚™ã—ã¦ã„ã¾ã™ã€‚
docker-compose.ymlã§ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã‚‹ã®ã§.envãƒ•ã‚¡ã‚¤ãƒ«ã«TOKENã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚

Dockerfile
```dockerfile
FROM node:13.8-alpine

ENV TZ Asia/Tokyo

# Hubotãƒ©ã‚¤ãƒ–ãƒ©ãƒªæº–å‚™
RUN npm install -g yo generator-hubot

# Hubotç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
RUN addgroup -S hubot && \
    adduser -S hubot -G hubot && \
    echo "hubot ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    echo 'hubot:hubot' | chpasswd

USER hubot

WORKDIR /app
```

docker-compose.yml
```yml
version: '3'
services:
  hubot:
    container_name: hubot
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
    stdin_open: true
    env_file:
      - .env
    tty: true
    restart: always
```

.env
```
HUBOT_SLACK_TOKEN=xxxxx
```

### Hubotã®è¨­å®š
Dockerç’°å¢ƒã‚’ç«‹ã¡ä¸Šã’ã¦ã€Containerã®ä¸­ã«å…¥ã‚Šã¾ã™ã€‚
```
$ docker-compose up -d
$ docker-compose exec hubot /bin/ash
```

yoã‚³ãƒãƒ³ãƒ‰ã§Hubotã‚’ä½œæˆã—ã¾ã™ã€‚
```
$ yo hubot
```

Hubotã‹ã‚‰è‰²ã€…èã‹ã‚Œã‚‹ã®ã§ç­”ãˆã¦ã„ã£ã¦ãã ã•ã„ã€‚
â€» Bot adapterã¯ã€Œslackã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
```
? ==========================================================================
We're constantly looking for ways to make yo better!
May we anonymously report usage statistics to improve the tool over time?
More info: https://github.com/yeoman/insight & http://yeoman.io
========================================================================== Yes
                     _____________________________
                    /                             \
   //\              |      Extracting input for    |
  ////\    _____    |   self-replication process   |
 //////\  /_____\   \                             /
 ======= |[^_/\_]|   /----------------------------
  |   | _|___@@__|__
  +===+/  ///     \_\
   | |_\ /// HUBOT/\\
   |___/\//      /  \\
         \      /   +---+
          \____/    |   |
           | //|    +===+
            \//      |xx|

? Owner nagi125.dev@gmail.com
? Bot name myhubot
? Description A simple helpful robot for your Company
? Bot adapter slack
```

### Scriptã®æº–å‚™
ã€Œscripts/ã€ã«CoffeeScriptã‚’æº–å‚™ã™ã‚Œã°å®Œæˆã§ã™ã€‚
execã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€Œchild_processã€ã‚’requireã—ã¦ãã ã•ã„ã€‚
scripts/sample.coffee

```coffee
child_process = require 'child_process'

module.exports = (robot) ->
  # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  robot.hear /ç–²ã‚ŒãŸ/i, (msg) ->
    msg.send  "é ‘å¼µã£ã¦ï¼"

  # ç”»åƒé€ä¿¡(imagesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹)
  robot.hear /ãƒ¨ã‚·ï¼/i, (msg) ->
    filename = 'images/neko.jpg'
    channel = msg.message.rawMessage.channel
    child_process.exec "curl -F file=@#{filename} -F channels=#{channel} -F token=#{process.env.HUBOT_SLACK_TOKEN} https://slack.com/api/files.upload"
```

### Hubotã‚’ç«‹ã¡ä¸Šã’ã‚‹
```
$ bin/hubot -a slack
```

### å‹•ä½œã‚’ç¢ºèªã™ã‚‹
![](https://storage.googleapis.com/zenn-user-upload/vbe7wcntgk284fa7wuuhb1cq6cbj)
ãƒ¨ã‚·ï¼

## Herokuã«Deployã™ã‚‹
heroku-cliåˆ©ç”¨å‰æã§æ›¸ãã¾ã™ã€‚([ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•](https://devcenter.heroku.com/articles/heroku-cli))

### Nodeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿®æ­£ã™ã‚‹
Localã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨æƒãˆã‚‹
```json
  "engines": {
    "node": "13.x"
  }
```

### Procfileã®ç¢ºèªã‚’ã™ã‚‹
Hubotä½œæˆæ™‚ã«slackã‚’æŒ‡å®šã—ãªã„ã¨Herokuã§ä½¿ã†Procfileã®è¨­å®šãŒä¸Šæ‰‹ãã„ã£ã¦ã„ãªã„ã®ã§ä¸‹è¨˜ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚
```
web: bin/hubot -a slack
```

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ
```
$ heroku apps:create your-app-name
```

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Deploy
â€» 2020/10/19ç¾åœ¨masterã§ã‚‚OK
```
$ git push heroku main
```

### ç’°å¢ƒå¤‰æ•°ã®ã‚»ãƒƒãƒˆ
Slackå´ã§ç™ºè¡Œã•ã‚ŒãŸTokenã‚’è¨­å®šã™ã‚‹
```
heroku config:set HUBOT_SLACK_TOKEN=xxxxx -a your-app-name
```

## æœ€å¾Œã«
æ°—åˆ†è»¢æ›ã«ä½œã£ãŸã‚‰æ„å¤–ã«ã‚‚ç¤¾å†…ã§è©•åˆ¤ãŒã‚ˆã‹ã£ãŸã®ã§è¨˜äº‹ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚
ã›ã£ã‹ãä½œã£ãŸã®ã§ç¤¾å†…ã®ä½œæ¥­è‡ªå‹•åŒ–ç­‰ã§æ´»ç”¨ã—ãŸã„ãªãƒ¼ã£ã¦æ€ã£ã¦ã¾ã™ã€‚
åŸºå¹¹ã‚·ã‚¹ãƒ†ãƒ å´ã§APIä½œã£ã¦ãƒ¬ãƒãƒ¼ãƒˆé€šçŸ¥ã¨ã‹ï¼Ÿ
