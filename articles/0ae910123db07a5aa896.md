---
title: "docker-composeã§Rails6ã®é–‹ç™ºç’°å¢ƒæ§‹ç¯‰å‚™å¿˜éŒ²"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['rails', 'docker']
published: true
---

## æ¦‚è¦
ç´ ç›´ã«ç’°å¢ƒæ§‹ç¯‰ã§ãã‚‹æƒ…å ±ã«ã‚ã¾ã‚ŠãŸã©ã‚Šç€ã‘ãªã‹ã£ãŸã®ã§ã€APIãƒ¢ãƒ¼ãƒ‰ã§ã¯ãªãé€šå¸¸ã®ãƒ¢ãƒ¼ãƒ‰ã§Railsã®ç’°å¢ƒã‚’ä½œã‚‹æ–¹æ³•ã‚’å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ãŠãã€‚
æœ¬ç•ªç’°å¢ƒã‚’ä½œã‚ŠãŸã„å ´åˆã¯åˆ¥é€”æœ¬ç•ªç”¨ã®Dockerfileã‚’æº–å‚™ã—ã¦ãã ã•ã„ã€‚

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³
Ruby: 2.7.4
Rails: 6.0.4
Nginx: 1.20.x
PostgreSQL: 12.x

## æ§‹æˆå›³
Nginxã§Railsã«RPã™ã‚‹æ§‹æˆã§ä½œæˆ
![](https://storage.googleapis.com/zenn-user-upload/eaaa844f28d52fc7e4b966f4.png)

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
dockeré–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’.dockeré…ä¸‹ã«æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚
```
.
â”œâ”€â”€ .docker
â”‚Â Â  â”œâ”€â”€ db
â”‚Â Â  â””â”€â”€ nginx
â”‚Â Â      â”œâ”€â”€ Dockerfile
â”‚Â Â      â””â”€â”€ conf
â”‚Â Â          â””â”€â”€ default.conf
â”œâ”€â”€ .git
â”œâ”€â”€ .gitignore
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Gemfile
â”œâ”€â”€ Gemfile.lock
â”œâ”€â”€ README.md
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ docker-entrypoint.sh
```

## å„ç¨®ãƒ•ã‚¡ã‚¤ãƒ«
### docker-compose.yml
```yml
version: '3'
services:
  nginx:
    container_name: nginx
    build:
      context: .docker/nginx
      dockerfile: Dockerfile
    ports:
      - 80:80
    depends_on:
      - app

  app:
    container_name: app
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      TZ: 'Asia/Tokyo'
      RAILS_ENV: 'development'
      DATABASE_HOST: 'db'
      DATABASE_NAME: 'app_development'
      DATABASE_USER: 'docker'
      DATABASE_PASSWORD: 'docker'
    volumes:
      - .:/app
    expose:
      - 3000
    tty: true
    stdin_open: true
    depends_on:
      - db

  db:
    image: postgres:12-alpine
    container_name: db
    environment:
      TZ: 'Asia/Tokyo'
      POSTGRES_USER: 'docker'
      POSTGRES_PASSWORD: 'docker'
      POSTGRES_DB: 'app_development'
    volumes:
      - database:/var/lib/postgresql/data
      - ./.docker/db/sql:/docker-entrypoint-initdb.d
    ports:
      - 5432:5432

volumes:
  database:
```

### appã®Dockerfile
- webpackerã‚’ä½¿ã†ãŸã‚yarnã‚’è¿½åŠ ã—ã¦ã„ã¾ã™
- ãƒ›ã‚¹ãƒˆã®IDEã§è£œå®Œã‚’åŠ¹ã‹ã›ãŸã„ãŸã‚bundle installã®pathã¯vendor/bundleã«ã—ã¦ã„ã¾ã™
```Dockerfile
FROM ruby:2.7.4

ENV TZ Asia/Tokyo
ENV LANG C.UTF-8

RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - && \
    echo 'deb http://dl.yarnpkg.com/debian/ stable main' > /etc/apt/sources.list.d/yarn.list

RUN apt-get update -qq && \
    apt-get install -y build-essential libpq-dev nodejs yarn && \
    apt-get clean && \
    rm -rf /var/cache/apt

WORKDIR /app

COPY Gemfile Gemfile.lock /app/

RUN bundle install --path vendor/bundle

CMD ["/bin/bash", "/app/docker-entrypoint.sh"]
```

### ã‚³ãƒ³ãƒ†ãƒŠç«‹ã¡ä¸Šã’æ™‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ(docker-entrypoint.sh)
pidãŒæ®‹ã£ã¦ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã§ããªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€å®Ÿè¡Œæ™‚ã«å‰Šé™¤å‡¦ç†ã‚’ã—ã¾ã™ã€‚
```sh
#!/bin/bash

I="\e[1;32m::\e[00m"

echo -e "$I Starting Rails Server..."
rm -f /app/tmp/pids/server.pid
bundle exec rails server -b '0.0.0.0'
```

### nginxã®Dockerfile
```Dockerfile
FROM nginx:1.20

RUN rm -f /etc/nginx/conf.d/*

COPY conf/default.conf /etc/nginx/conf.d/default.conf
```

### nginxã®conf
railsã«RPã™ã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠåã®ã€Œappã€ã‚’æŒ‡å®šã—ã¦ã„ã‚‹
```conf
server {
    listen 80;

    proxy_set_header    Host                 $host;
    proxy_set_header    X-Real-IP            $remote_addr;
    proxy_set_header    X-Forwarded-Host     $host;
    proxy_set_header    X-Forwarded-Server   $host;
    proxy_set_header    X-Forwarded-For      $proxy_add_x_forwarded_for;

    location / {
        proxy_pass    http://app:3000;
    }
}
```

### Gemfile
```Gemfile
source 'https://rubygems.org'
gem 'rails', '~> 6.0.4'
```

### Gemfile.lock
ç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ˆã„
```
```

## ç’°å¢ƒæ§‹ç¯‰æ‰‹é †
1. å„ç¨®ã‚³ãƒ³ãƒ†ãƒŠã®Build
    ```
    $ docker-compose build
    ```
1. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æº–å‚™(railsã‚³ãƒãƒ³ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚‹)
    ```
    $ docker-compose run --rm app bundle install
    ```
1. Railsã®åˆæœŸåŒ–
    ```
    $ docker-compose run --rm app bundle exec rails new . -f -B -d postgresql
    ```
1. Railsã®ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒGemfileã«æ›¸ãå‡ºã•ã‚Œã‚‹ã®ã§ã‚‚ã†ä¸€å›bundle install
    ```
    $ docker-compose run --rm app bundle install
    ```
1. webpackerã®è¿½åŠ (Pumaã‚’ç«‹ã¡ä¸Šã’ã‚ˆã†ã¨ã™ã‚‹ã¨æ€’ã‚‰ã‚Œã‚‹ãŸã‚è¿½åŠ )
    ```
    $ docker-compose run --rm app bundle exec rails webpacker:install
    ```
1. database.ymlã®ç·¨é›†(DBè¨­å®šã‚’ã—ãªã„ã¨DBæ¥ç¶šã‚¨ãƒ©ãƒ¼ã«ãªã‚‹)
    ```yml
    # config/database.yml

    default: &default
    adapter: postgresql
    encoding: unicode
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

    development:
    <<: *default
    host: <%= ENV['DATABASE_HOST'] %>
    database: <%= ENV['DATABASE_NAME'] %>
    username: <%= ENV['DATABASE_USER'] %>
    password: <%= ENV['DATABASE_PASSWORD'] %>

    test:
    <<: *default
    host: <%= ENV['DATABASE_HOST'] %>
    database: app_test
    username: <%= ENV['DATABASE_USER'] %>
    password: <%= ENV['DATABASE_PASSWORD'] %>

    production:
    <<: *default
    database: app_production
    username: app
    password: <%= ENV['APP_DATABASE_PASSWORD'] %>

    ```
1. èµ·å‹•
    ```
    $ docker-compose up
    ```
1. ãƒ–ãƒ©ã‚¦ã‚¶ã§http://localhost
    ä¾‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹

## Gemã®è¿½åŠ æ‰‹é †
1. Gemfileã«è¨˜è¿°
  ```Gemfile
  gem 'kaminari'
  ```
1. èµ·å‹•ä¸­ã«ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§Gemã®è¿½åŠ 
  ```
  $ docker-compose exec app bundle install 
  ```
1. Appã®å†èµ·å‹•
  ```
  $ docker-compose restart
  ```

## çµ‚ã‚ã‚Šã«
å‚™å¿˜éŒ²ã¨ãªã‚Šã¾ã™ã®ã§ç´°ã‹ã„èª¬æ˜ã¯çœã„ã¦ã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã§IDEå´ã§è£œå®Œã‚’æœ‰åŠ¹ã«ã—ãªãŒã‚‰Railsã®é–‹ç™ºãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚