---
title: "GitHub Actionsã§ECSãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«task-definition.jsonã«ç§˜å¯†æƒ…å ±ã‚’å¤–éƒ¨ã‹ã‚‰æ³¨å…¥ã™ã‚‹"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws, ecs, github, githubactions]
published: true
---

## æ¦‚è¦
GitHub Actionsã§ECSã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã—ã‚ˆã†ã¨ã—ãŸã¨ã“ã‚ã€task-definitionã«ç§˜å¯†æƒ…å ±ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã§ã¦ãã¦ã—ã¾ã„å›°ã£ãŸã®ã§è§£æ±ºæ–¹æ³•ã‚’è¨˜éŒ²ã—ã¦ãŠãã€‚

## çµè«–
task-definition.jsonã«ç‰¹å®šã®æ–‡å­—åˆ—ã‚’æ›¸ã„ã¦ãŠãã€sedã‚³ãƒãƒ³ãƒ‰ã§GitHubç®¡ç†ã®secretã«æ›¸ãæ›ãˆã‚‹ã€‚

## task-definition
ã‚µãƒ³ãƒ—ãƒ«ãªã®ã§AWSã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã‚’ç§˜å¯†æƒ…å ±æ‰±ã„ã‚’ã—ã¦ãŠã‚Šã€ä»Šå›ã¯ã€ŒSED_TARGET_AWS_ACCOUNT_IDã€ã¨ã—ã¦ã„ã¾ã™ã€‚
â€» ç­†è€…ã®å ´åˆGrafanaã®Lokiã¸ã®ãƒ­ã‚°è»¢é€è¨­å®šã‚’ã™ã‚‹éš›ã«ç§˜å¯†æƒ…å ±ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã§ã¦ãã¦å›°ã‚Šã¾ã—ãŸã€‚
```json
{
  "executionRoleArn": "arn:aws:iam::SED_TARGET_AWS_ACCOUNT_ID:role/sample-TaskExecution",
  "taskRoleArn": "arn:aws:iam::SED_TARGET_AWS_ACCOUNT_ID:role/sample-TaskExecution",
  "family": "sample-app",

  //   ....
  
  "containerDefinitions": [
    {
      "name": "nginx",
      "image": "SED_TARGET_AWS_ACCOUNT_ID.dkr.ecr.ap-northeast-1.amazonaws.com/nginx:latest",
      "portMappings": [
        {
          "containerPort": 80,
          "hostPort": 80,
          "protocol": "tcp"
        },
      ],

      // ....

    }
  ]
}
```

## GitHub Actionsã®Workflow
Deployå‡¦ç†ã‚’èµ°ã‚‰ã›ã‚‹å‰ã«sedã‚³ãƒãƒ³ãƒ‰ã§ç§˜å¯†æƒ…å ±ã‚’æ³¨å…¥ã—ã¦ã‚ã’ã‚‹ã¨ã‚ˆã„ã§ã™ã€‚
```yml
jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # ....

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # Rewrite task-definition(ç§˜å¯†æƒ…å ±ã‚’æ³¨å…¥ã™ã‚‹)
      - name: rewrite task-definition
        run: sed -i -e s/SED_TARGET_AWS_ACCOUNT_ID/${{ secrets.AWS_ACCOUNT_ID }}/g .aws/ecs/task-definition.json

      # ...

      # Deploy
      - name: Render Amazon ECS task definition for first container
        id: render-web-container
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .aws/ecs/task-definition.json
          container-name: nginx
          image: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com/nginx:latest
```

## æ³¨æ„äº‹é …
ã‚³ãƒ³ãƒ†ãƒŠã®ç’°å¢ƒå¤‰æ•°ã«ç§˜å¯†æƒ…å ±ã‚’æŒãŸã›ãŸã„å ´åˆã¯ã‚·ã‚¹ãƒ†ãƒ ãƒãƒãƒ¼ã‚¸ãƒ£ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚’åˆ©ç”¨ã™ã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚