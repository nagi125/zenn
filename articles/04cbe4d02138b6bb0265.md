---
title: "SalesForceã®Access Tokenå–å¾—æ–¹æ³•"
emoji: "ðŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['SalesForce', 'OAuth', 'Laravel']
published: true
---

## æ¦‚è¦
SalesForceã®AccessTokenå–å¾—æ–¹æ³•ã‚’ã¾ã¨ã‚ã¦ãŠãã€‚
â€»refresh_tokenã«ã¤ã„ã¦ã¯[ã“ã¡ã‚‰ã‚’å‚ç…§](https://zenn.dev/nagi125/articles/29bfe0386fb0bd9e655e)
åŒæ™‚ã«Laravel + Guzzuleã‚’åˆ©ç”¨ã—ãŸPHPã®ã‚µãƒ³ãƒ—ãƒ«ã‚‚è¼‰ã›ã¦ãŠãã€‚

## çµè«–
å–å¾—æ–¹æ³•ã¯è¤‡æ•°ã‚ã‚‹ãŒã“ã“ã§ã¯ã€Œãƒ¦ãƒ¼ã‚¶åãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã€ã¨ã€Œæ›´æ–°ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼ã€ã®2ç¨®é¡žã‚’è¨˜è¼‰ã™ã‚‹ã€‚
â€» åˆ©ç”¨ã—ã¦ã„ã‚‹APIã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯v47.0ã§ã™ã€‚

## å…±é€šä½œæ¥­
- æŽ¥ç¶šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆã‚’ã™ã‚‹ã€‚([ã“ã¡ã‚‰ã®è¨˜äº‹](https://zenn.dev/nagi125/articles/29bfe0386fb0bd9e655e)ã‚’å‚ç…§)

## ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã¤ã‘ã¦ä¸‹è¨˜ã®URLã«ã€ŒPOSTã€ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚
https://login.salesforce.com/services/oauth2/token

|ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿|å€¤|
|:--|:--|
|grant_type|password|
|client_id|*****|
|client_secret|*****|
|username|****|
|password|****|

![](https://storage.googleapis.com/zenn-user-upload/zc233n6ak4400qdxl4ygwv02e4df)

## æ›´æ–°ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼
refresh_tokenãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€refresh_tokenã‚’[ã“ã¡ã‚‰ã®è¨˜äº‹ã®æ–¹æ³•](https://zenn.dev/nagi125/articles/29bfe0386fb0bd9e655e)ã§å–å¾—ã—ã¦ãŠãã€‚
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã¤ã‘ã¦ä¸‹è¨˜ã®URLã«ã€ŒPOSTã€ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚
https://login.salesforce.com/services/oauth2/token

|ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿|å€¤|
|:--|:--|
|grant_type|refresh_token|
|client_id|*****|
|client_secret|*****|
|refresh_token|*****|

![](https://storage.googleapis.com/zenn-user-upload/cjaemsjpl5wjflpf7v2igduowtlh)

## Laravel + Guzzleã‚µãƒ³ãƒ—ãƒ«
Laravelã‚’åˆ©ç”¨ã—ã¦æ›¸ã„ã¦ã„ã¾ã™ãŒã€æ©Ÿèƒ½ã¨ã—ã¦ã¯envãã‚‰ã„ã—ã‹ä½¿ã£ã¦ã„ãªã„ã®ã§ç”ŸPHPã§ã‚‚æ™®é€šã«ã„ã‘ã¾ã™ã€‚
Guzzleã‚’åˆ©ç”¨ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã¨æ€ã£ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

```php
    private function refreshSFAccessToken(): string
    {
        $path = '/services/oauth2/token';
        $url  = 'https://login.salesforce.com' . $path;

        $params = [
            'form_params' => [
                'grant_type' => 'refresh_token',
                'client_id'  => env('SF_ID'),
                'client_secret' => env('SF_SECRET'),
                'refresh_token' => env('SF_REFRESH_TOKEN'),
            ]
        ];

        $client  = new \GuzzleHttp\Client();
        $resJson = $client->request('POST', $url, $params)->getBody()->getContents();
        $resAry  = json_decode($resJson, true);

        return $resAry['access_token'] ?? '';
    }
```
