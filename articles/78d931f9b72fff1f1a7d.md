---
title: "Laravel Sanctum(Laravel8)ã¨Nuxt.jsã«ã‚ˆã‚‹SPAèªè¨¼"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['docker', 'laravel', 'nuxtjs']
published: true
---

## æ¦‚è¦
æ¥­å‹™ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚’åˆ†é›¢ã—ãŸããªã£ã¦Laravelã®APIèªè¨¼ã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ã‚‹ã¨ã€
Laravel7ã‹ã‚‰Sanctumã®åˆ©ç”¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ãŸã€‚
Nuxtã¨ã®é€£æºã‚’èª¿æŸ»ã—ãŸã®ã§ä½œæ¥­ãƒ­ã‚°ã‚‚å…¼ã­ã¦è¨˜äº‹ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚

## Sanctumã«ã¤ã„ã¦
APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã‚¿ã‚¤ãƒ—ã¨ã€SPAèªè¨¼ã®2ç¨®é¡ã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
ã“ã“ã§ã¯SPAèªè¨¼ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
[å’Œè¨³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://readouble.com/laravel/8.x/ja/sanctum.html)

## å®Œæˆå“
æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰ã‚’ç½®ã„ã¦ãŠãã¾ã™ã€‚
https://github.com/nagi125/nuxt_laravel_auth_spa_sample
![](https://storage.googleapis.com/zenn-user-upload/354yngp0bbtb8cdkopo33vq7q7ig)

## ç’°å¢ƒ
docker-composeã§æ§‹æˆã—ã€nginxã§RPã—ã¦ã„ã¾ã™ã€‚

- Host:Mac
- Docker
  - nginx:1.19-alpine
  - node:13.8-alpine (Nuxt2.14.x)
  - php:7.4-fpm-alpine (Laravel8.x)

docker-composeã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

```yml
version: '3'
services:
  nginx:
    container_name: nginx
    build:
      context: ./.docker/nginx
      dockerfile: Dockerfile
    ports:
      - 80:80
    tty: true
    restart: always
    depends_on:
      - web

  web:
    container_name: web
    build:
      context: ./.docker/web
      dockerfile: Dockerfile
    environment:
      PORT: '3000'
      HOST: '0.0.0.0'
    expose:
      - 3000
    volumes:
      - ./web:/app
    stdin_open: true
    tty: true
    restart: always
    depends_on:
      - api

  api:
    container_name: api
    build:
      context: ./.docker/api
      dockerfile: Dockerfile
    environment:
      LANG: 'ja_JP.UTF-8'
      TZ: 'Asia/Tokyo'
      LOG_CHANNEL: 'stderr'
      DB_CONNECTION: 'pgsql'
      DB_HOST: 'db'
      DB_PORT: '5432'
      DB_DATABASE: 'laravel_development'
      DB_USERNAME: 'docker'
      DB_PASSWORD: 'docker'
      SESSION_DOMAIN: 'localhost'
      SANCTUM_STATEFUL_DOMAINS: 'localhost'
    volumes:
      - ./api:/app
    expose:
      - 9000
    tty: true
    restart: always
    depends_on:
      - db

  db:
    image: postgres:12
    container_name: db
    environment:
      TZ: 'Asia/Tokyo'
      POSTGRES_USER: 'docker'
      POSTGRES_PASSWORD: 'docker'
      POSTGRES_DB: 'laravel_development'
    volumes:
      - db:/var/lib/postgresql/data
    ports:
      - 5432:5432

volumes:
  db:
```
ã€Œnginxã€ã€Œwebã€ã€Œapiã€ã‚³ãƒ³ãƒ†ãƒŠã®ç´°ã‹ã„æ§‹æˆã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚
https://github.com/nagi125/nuxt_laravel_auth_spa_sample/tree/main/.docker

## æ¤œè¨¼ç’°å¢ƒæ§‹ç¯‰
å®Œæˆå“ã‚’Cloneã—ã¦ã„ãŸã ã„ã¦ã€ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§æº–å‚™ã€‚

```
$ docker-compose up
```

### Nuxtå´
```
$ docker-compose exec web yarn install
$ docker-compose exec web yarn dev
```

### Laravelå´
```
$ docker-compose exec api composer install
$ docker-compose exec api cp .env.example .env
$ docker-compose exec api php artisan key:generate 
$ docker-compose exec api php artisan migrate:refresh --seed
```
ä»¥ä¸Šã§ã€Nuxtå´ãƒ»Laravelå´ã®æº–å‚™ãŒå®Œäº†ã§ã™ã€‚

### å‹•ä½œç¢ºèª
http://localhost/login
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨passwordã«ã¤ã„ã¦ã¯Laravelå´ã®seedã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚
http://localhost/secret
ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚Œã°èªè¨¼æˆåŠŸã§ã™ã€‚

## èªè¨¼è¨­å®šã«ã¤ã„ã¦
èªè¨¼è¨­å®šã«ã¤ã„ã¦ä½•ã‚’ã—ãŸã®ã‹è¨˜è¼‰ã—ã¦ã„ãã¾ã™ã€‚

### Laravelå´

#### Sanctumã®æº–å‚™
```
$ docker-compose exec api composer require laravel/sanctum
$ docker-compose exec api php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"
```

#### Sanctumã®è¨­å®š
api/app/Http/Kernel.phpã«Classã‚’è¿½åŠ 

```php
<?php

namespace App\Http;

use Illuminate\Foundation\Http\Kernel as HttpKernel;
use Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful; // è¿½åŠ 

// ...

    protected $middlewareGroups = [
        'api' => [
            EnsureFrontendRequestsAreStateful::class, // è¿½åŠ 
            'throttle:api',
            \Illuminate\Routing\Middleware\SubstituteBindings::class,
        ],
    ];
```

api/config/cors.phpã«CORSè¨­å®š

```php
<?php

return [
    'paths' => ['api/*'], // å¤‰æ›´
    'allowed_methods' => ['*'],
    'allowed_origins' => ['http://localhost:3000'], // å¤‰æ›´
    'allowed_origins_patterns' => [],
    'allowed_headers' => ['*'],
    'exposed_headers' => [],
    'max_age' => 0,
    'supports_credentials' => true, // å¤‰æ›´
];

```

.envã«ç’°å¢ƒå¤‰æ•°ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
â€»ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã¯docker-compose.ymlã«ç’°å¢ƒå¤‰æ•°ã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã™ã€‚

```
SESSION_DOMAIN=localhost
SANCTUM_STATEFUL_DOMAINS=localhost
```

#### LoginControllerã®æº–å‚™
æœ€ä½é™ã®å‹•ä½œã•ãˆã™ã‚Œã°ã„ã„å®Ÿè£…ã«ã—ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã«ä½¿ã†å ´åˆã¯Validationå«ã‚ä½œã‚Šè¾¼ã‚“ã§ãã ã•ã„ã€‚
api/app/Http/Controllers/Api/Auth/LoginController.php

```php
<?php

namespace App\Http\Controllers\Api\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class LoginController extends Controller
{
    /**
     * @Method POST
     * @param  Request  $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function login(Request $request): JsonResponse
    {
        $credentials = $request->validate([
            'email' => 'required|email',
            'password' => 'required'
        ]);

        if (auth()->attempt($credentials)) {
            return response()->json(['message' => 'OK!'], 200);
        }

        return response()->json(['message' => 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'], 422);
    }
}
```
#### Routeã®è¨­å®š
èªè¨¼ç”¨ã®Routeã¨Useræƒ…å ±å–å¾—ç”¨ã®Routeã‚’è¨­å®šã—ã¾ã™ã€‚
â€» Laravel8ã‹ã‚‰Controllerã®æŒ‡å®šã®ä»•æ–¹ãŒå¤‰ã‚ã£ãŸã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
api/routes/api.php
```php
<?php

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\Api\Auth\LoginController;

Route::prefix('auth')->group(function() {
    Route::post('/login', [LoginController::class, 'login']);
});

Route::middleware('auth:sanctum')->get('/user', function (Request $request) {
    return $request->user();
});

```

Laravelå´ã¯ä»¥ä¸Šã§æº–å‚™å®Œäº†ã§ã™ã€‚

### Nuxtå´
Nuxtã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã«ã¯Universalãƒ¢ãƒ¼ãƒ‰ã¨SPAãƒ¢ãƒ¼ãƒ‰ã¨ã‚ã‚Šã¾ã™ãŒã€SPAãƒ¢ãƒ¼ãƒ‰ã§ä½œæˆã—ã¾ã™ã€‚
â€»1. SSRã§ã¯storeã®é–¢ä¿‚ä¸Šã€Middlewareã§Authã®è¨­å®šãŒä¸Šæ‰‹ãåæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚
â€»2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæ™‚ã«Axiosã¨BootStrapã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

#### å¿…è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã›ã°installã•ã‚Œã¦ã„ã¾ã™ãŒã€ä½œæ¥­ãƒ­ã‚°ã¨ã—ã¦è¨˜éŒ²ã—ã¦ãŠãã¾ã™ã€‚

```
$ docker-compose exec web yarn add @nuxtjs/auth
```

#### Authè¨­å®š
web/nuxt.config.js
```js
export default {
  // ....

  modules: [
    'bootstrap-vue/nuxt',
    '@nuxtjs/auth', // è¿½è¨˜
    '@nuxtjs/axios', // è¿½è¨˜
  ],
  axios: {
    baseURL: "http://localhost",
    credentials: true,
  },
  auth: {
    redirect: {
      login: '/login',
      logout: '/',
      callback: false,
      home: '/'
    },
    strategies: {
      local: {
        endpoints: {
          login: { url: '/api/auth/login', method: 'post', propertyName: false },
          user: { url: '/api/user', method: 'get', propertyName: false },
          logout: false
        },
        tokenRequired: false,
        tokenType: false,
      }
    },
    localStorage: false,
  },
  router: {
    middleware: ['auth']
  },
}
```

#### Storeè¨­å®š
storeåˆ©ç”¨ã™ã‚‹ãŸã‚ã«index.jsç”¨æ„ã—ã‚ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§ä½œæˆã—ã¾ã™ã€‚

```
$ docker-compose exec web touch store/index.js
```

#### Loginãƒšãƒ¼ã‚¸è¨­å®š
ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãŸã ã‘ã‚Œã°ã‚ˆã„ã®ã§ã™ãŒã€Loginãƒšãƒ¼ã‚¸ã ã‘è¨˜è¼‰ã—ã¦ãŠãã¾ã™ã€‚
web/pages/login.vue

```js
<template>
  <div class="container">
    <h1 class="h1 pb-1 border-bottom border-dark">Login</h1>
    <p>ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: {{ $auth.loggedIn }}</p>
    <div class="row justify-content-md-center">
      <div class="col-6">
        <form name="login" @submit.prevent="login()">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" class="form-control" id="email" placeholder="Enter email" v-model="form.email" required />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" class="form-control" id="password" placeholder="Enter password" v-model="form.password" required />
          </div>
          <button type="submit" class="btn btn-success">Submit</button>
        </form>
      </div>
    </div>
  </div>
</template>

<script>
  export default {
    data() {
      return {
        form: {
          email: '',
          password: ''
        },
      };
    },
    mounted() {
      // csrfå¯¾ç­– 
      // nginxã§RPã™ã‚‹å ´åˆã¯/sanctumãŒapiå´ã‚’è¦‹ã«è¡Œãã‚ˆã†ã«ã—ã¦ãã ã•ã„
      this.$axios.get('/sanctum/csrf-cookie');
    },
    methods: {
      async login() {
        try {
          const response = await this.$auth.loginWith('local', { data: this.form });
          console.log(response);

        } catch(error) {
          console.log(error);
        }
      },
    },
  };
</script>
```

ä½œæ¥­ã¯ä»¥ä¸Šã¨ãªã‚Šã¾ã™ã€‚

## æœ€å¾Œã«
ä»Šå›ã¯Laravel Sanctumã‚’åˆ©ç”¨ã—ãŸSPAèªè¨¼ã«ã¤ã„ã¦æ›¸ãã¾ã—ãŸã€‚
èª²é¡Œã¯SSRæ™‚ã«ã©ã†ã™ã‚‹ã‹ã§ã™ã­ã€‚ãã¡ã‚‰ã‚‚è§£æ±ºã§ããŸã‚‰ã¾ãŸè¨˜äº‹ã‚’æ›¸ããŸã„ã¨æ€ã„ã¾ã™ã€‚
