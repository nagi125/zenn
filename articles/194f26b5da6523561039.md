---
title: "GitHub Actionsã§ãƒ†ã‚¹ãƒˆã‚’èµ°ã‚‰ã›ã¦ã‹ã‚‰Laravelã‚’Herokuã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ˜‡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['github', 'laravel', 'heroku']
published: true
---

## æ¦‚è¦
ãƒ†ã‚¹ãƒˆã‚’å°å…¥ã™ã‚‹éš›ã«èª¿ã¹ãŸã®ã§è¨˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚

## ç’°å¢ƒ
- PHP:7.4.x
- Laravel:6.x
- PostgreSQL:12.x

## å‰æ
- ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹ã«ã¤ã„ã¦ã¯çœç•¥ã™ã‚‹
- GitHubActionsã§ã¯ç’°å¢ƒã«åˆã‚ã›ã¦PostgreSQLã‚’åˆ©ç”¨ã™ã‚‹

## GitHubActionsç”¨ã®è¨­å®š
### ãƒ†ã‚¹ãƒˆç”¨ã®DB_CONNECTIONã‚’æº–å‚™ã™ã‚‹
ãƒ­ãƒ¼ã‚«ãƒ«ã®ç’°å¢ƒä¸Šã€DB_DATABASE_TESTã«ã—ã¦ã¾ã™ãŒã€å•é¡Œç„¡ã„ã®ã§ã‚ã‚Œã°DB_DATABASEã§ã‚‚å¤§ä¸ˆå¤«ãªã¯ãšã§ã™ã€‚

config/database.php
```php
'connections' => [
    'testing' => [
        'driver' => 'pgsql',
        'url' => env('DATABASE_URL'),
        'host' => env('DB_HOST', '127.0.0.1'),
        'port' => env('DB_PORT', '5432'),
        'database' => env('DB_DATABASE_TEST', 'laravel_testing'),
        'username' => env('DB_USERNAME', 'forge'),
        'password' => env('DB_PASSWORD', ''),
        'charset' => 'utf8',
        'prefix' => '',
        'prefix_indexes' => true,
        'schema' => 'public',
        'sslmode' => 'prefer',
    ],
]
```

### PHPUnitã®è¨­å®šã‚’ã™ã‚‹
ãƒ­ãƒ¼ã‚«ãƒ«ç”¨ã«ã€Œserverã€ã‹ã‚‰ã€Œenvã€ã«æ›¸ãæ›ãˆã¦ã¾ã™ãŒã€
DB_CONNECTIONã¨DB_DATABASE_TESTã®è¨­å®šã‚’é–“é•ã‚ãªã‘ã‚Œã°å‹•ãã¯ãšã§ã™ã€‚

phpunit.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="./vendor/phpunit/phpunit/phpunit.xsd"
         backupGlobals="false"
         backupStaticAttributes="false"
         bootstrap="vendor/autoload.php"
         colors="true"
         convertErrorsToExceptions="true"
         convertNoticesToExceptions="true"
         convertWarningsToExceptions="true"
         processIsolation="false"
         stopOnFailure="false">
    <testsuites>
        <testsuite name="Unit">
            <directory suffix="Test.php">./tests/Unit</directory>
        </testsuite>

        <testsuite name="Feature">
            <directory suffix="Test.php">./tests/Feature</directory>
        </testsuite>
    </testsuites>
    <filter>
        <whitelist processUncoveredFilesFromWhitelist="true">
            <directory suffix=".php">./app</directory>
        </whitelist>
    </filter>
    <php>
        <env name="APP_ENV" value="testing" force="true"/>
        <env name="BCRYPT_ROUNDS" value="4"/>
        <env name="CACHE_DRIVER" value="array"/>
        <env name="DB_CONNECTION" value="testing" force="true"/>
        <env name="DB_DATABASE_TEST" value="laravel_testing" force="true"/>
        <env name="MAIL_DRIVER" value="array"/>
        <env name="QUEUE_CONNECTION" value="sync"/>
        <env name="SESSION_DRIVER" value="array"/>
    </php>
</phpunit>

```

### GitHubActionç”¨ã®ç’°å¢ƒå¤‰æ•°è¨­å®šç”¨ã«.env.githubæº–å‚™ã™ã‚‹
.env.github
```
APP_NAME=Laravel
APP_KEY=
APP_URL=http://localhost

DB_CONNECTION=testing
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE_TEST=laravel_testing
DB_USERNAME=postgres
DB_PASSWORD=postgres
```

### GitHubActionsç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã™ã‚‹
å…¬å¼ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒä½œæˆã§ãã¾ã™ã®ã§ã€ãã‚Œã‚’åˆ©ç”¨ã—ã¦å°‘ã—ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/380rwerifah60xfycfetpwjij7sg)


#### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ”¹å¤‰ã™ã‚‹
- postgresã®è¨­å®šã‚’è¿½åŠ ã™ã‚‹
- å‡¦ç†ã‚’è¦‹ã¦ã¿ã‚‹ã¨.env.exampleã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€ãƒ†ã‚¹ãƒˆã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ã¾ã¨ã‚ãŸ.env.githubã«æ›¸ãæ›ãˆã‚‹
- migrateã¨seedã®å®Ÿè¡Œã‚’è¿½åŠ 

.github/workflows/laravel.yml
```yml
name: Laravel

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  laravel-tests:

    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:12
        env:
          POSTGRES_USER: 'postgres'
          POSTGRES_PASSWORD: 'postgres'
          POSTGRES_DB: 'laravel_testing'
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
        - 5432:5432
    steps:
    - uses: actions/checkout@v2
    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.github', '.env');"
    - name: Install Dependencies
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-suggest --no-progress --prefer-dist
    - name: Generate key
      run: php artisan key:generate
    - name: Directory Permissions
      run: chmod -R 777 storage bootstrap/cache
    - name: Execute Migration & Seed
      run: php artisan migrate:refresh --seed --force
    - name: Execute tests (Unit and Feature tests) via PHPUnit
      run: vendor/bin/phpunit
```

ã“ã‚Œã§Pushã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ãƒ—ãƒ«ãƒªã‚¯ã‚’å‡ºã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ†ã‚¹ãƒˆãŒèµ°ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## Herokuå´ã®è¨­å®š
### GitHubã®ãƒªãƒã‚¸ãƒˆãƒªã¨é€£æº
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã€ŒDeployã€ã‚¿ãƒ–ã‹ã‚‰ä¸‹è¨˜ã®æ‰‹é †ã§è¨­å®šã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/s8gxxnadwmz956vk9a3e67if55xt)


### Deployã®è‡ªå‹•åŒ–
ãƒ–ãƒ©ãƒ³ãƒã‚’é¸æŠã—ã¦ã€ã€ŒWait for CI to pass before deployã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/lqvspk4g6guq5wmqzwq5xc5sg5ts)

## æœ€å¾Œã«
å¤§å¤‰ã ã‚ã†ã¨æ€ã£ã¦å¾Œå›ã—ã«ã—ã¦ã„ã¾ã—ãŸãŒã€å®Ÿéš›ã¯ã“ã®ã‚ˆã†ãªæ„Ÿã˜ã§ç°¡å˜ã«CI/CDç’°å¢ƒãŒæ§‹ç¯‰ã§ãã¾ã™ã€‚
å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
